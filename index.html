<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Work App - Firebase Realtime</title>
<style>
body { font-family: Arial, sans-serif; background: #f0f0f0; margin: 0; padding: 20px; }
h1 { text-align: center; color: #333; }
.screen { display: none; }
.card { background: #fff; padding: 15px; border-radius: 15px; box-shadow: 0 8px 15px rgba(0,0,0,0.1); margin-bottom: 20px; }
.btn { padding: 12px 25px; border: none; border-radius: 12px; font-size: 16px; font-weight: bold; cursor: pointer; box-shadow: 0 6px #999; }
.btn:active { box-shadow: 0 3px #666; transform: translateY(3px); }
.btn-open { background-color: #28a745; color: #fff; }
.btn-close { background-color: #dc3545; color: #fff; }
.worker-card { background: linear-gradient(135deg, #a1c4fd, #c2e9fb); padding: 15px; border-radius: 15px; margin-bottom: 15px; box-shadow: 0 6px 12px rgba(0,0,0,0.2); }
.table { width: 100%; border-collapse: collapse; margin-top: 10px; }
.table th, .table td { border: 1px solid #ccc; padding: 8px; text-align: center; }
.small { color:#666; font-size: 13px; }
</style>
</head>
<body>
<h1>My Work App - Firebase Realtime</h1>
<div style="text-align:center; margin-bottom:20px;">
  <button onclick="showScreen('worker')" class="btn" style="margin-right:10px;">Worker</button>
  <button onclick="showScreen('owner')" class="btn">Owner</button>
</div>

<!-- Worker Screen -->
<div id="workerScreen" class="screen" style="display:block;">
  <div class="card">
    <label>Name:</label><br>
    <input type="text" id="workerName" placeholder="Enter your name" style="padding:8px; width:80%; border-radius:8px; border:1px solid #ccc;">
  </div>
  <div class="card" style="text-align:center;">
    <button class="btn btn-open" onclick="logTime('open')">OPEN</button>
    <button class="btn btn-close" onclick="logTime('close')" style="margin-left:15px;">CLOSE</button>
  </div>
  <div class="card">
    <h3>Latest Entry (This Device):</h3>
    <div id="latestEntry">—</div>
  </div>
</div>

<!-- Owner Screen -->
<div id="ownerScreen" class="screen">
  <div class="card">
    <label>Enter Owner Code:</label><br>
    <input type="password" id="ownerCode" placeholder="Enter code" style="padding:8px; width:60%; border-radius:8px; border:1px solid #ccc;">
    <button class="btn btn-open" onclick="ownerLogin()" style="margin-left:10px;">Login</button>
    <button class="btn" onclick="togglePassword()" style="margin-left:10px;">Show/Hide</button>
    <p id="authMsg" style="color:red; display:none;">Wrong code!</p>
  </div>
  <div id="ownerPanel" style="display:none;">
    <div class="card">
      <label>12-hour Salary Amount:</label><br>
      <input type="number" id="salaryRate" placeholder="350" style="padding:8px; width:60%; border-radius:8px; border:1px solid #ccc;">
      <button class="btn btn-open" onclick="saveSalaryRate()" style="margin-left:10px;">Save Rate</button>
      <p class="small">Rate applies proportionally. Example: 12h = 350 → 1h = 29.17.</p>
    </div>
    <div class="card">
      <button class="btn btn-close" onclick="deleteMonthHistory()">Delete This Month History</button>
    </div>
    <div id="workerHistory"></div>
  </div>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
// ---------------- Firebase Init ----------------
const firebaseConfig = {
  apiKey: "AIzaSyCQZjF8KrXcjB2Fkkvu9NGpjp2lAfepac8",
  authDomain: "dil-ki-aawaz.firebaseapp.com",
  projectId: "dil-ki-aawaz",
  storageBucket: "dil-ki-aawaz.appspot.com",
  messagingSenderId: "538419616399",
  appId: "1:538419616399:web:4fc76e6d58f00d90792efa"
};

firebase.initializeApp(firebaseConfig);
const db = firebase.firestore();
let salaryRate = Number(localStorage.getItem('salaryRate')) || 350;
document.addEventListener('DOMContentLoaded', ()=>{
  const sr = document.getElementById('salaryRate');
  if(sr) sr.value = salaryRate;
});

// Helper to get month key like 2025-08
function monthKeyFromDate(d){
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`;
}

function showScreen(screen){
  document.getElementById('workerScreen').style.display = screen==='worker'?'block':'none';
  document.getElementById('ownerScreen').style.display = screen==='owner'?'block':'none';
}

// -------------- Worker: OPEN/CLOSE --------------
async function logTime(type){
  const name = document.getElementById('workerName').value.trim();
  if(!name){ alert('Enter your name'); return; }

  const now = new Date();
  const mKey = monthKeyFromDate(now);
  const docRef = db.collection('workData').doc(mKey);

  try {
    const docSnap = await docRef.get();
    let data = docSnap.exists ? docSnap.data() : {};
    if(!data[name]) data[name] = [];

    if(type==='open'){
      const arr = data[name];
      if(arr.length && !arr[arr.length-1].end){
        alert('You already have an active session. Please CLOSE first.');
        return;
      }
      data[name].push({ start: now.toISOString(), end: null, hours: 0, pay: 0 });
    } else {
      const arr = data[name];
      if(arr.length===0 || arr[arr.length-1].end){
        alert('No active session to CLOSE.');
        return;
      }
      const last = arr[arr.length-1];
      last.end = now.toISOString();
      const hrs = (new Date(last.end) - new Date(last.start)) / 36e5;
      last.hours = parseFloat(hrs.toFixed(2));
      const perHour = salaryRate / 12; 
      last.pay = parseFloat((perHour * hrs).toFixed(2));
    }

    await docRef.set(data, { merge: true });
    document.getElementById('latestEntry').innerText = 
      `${name} - ${now.toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'medium' })}`;
  } catch(e){
    console.error(e);
    alert('Firestore write failed. Check rules or network.');
  }
}

// -------------- Owner: Auth + Live View --------------
function ownerLogin(){
  const code = document.getElementById('ownerCode').value.trim();
  if(code==='Faraz_09'){
    document.getElementById('ownerPanel').style.display='block';
    document.getElementById('authMsg').style.display='none';
    listenRealtimeUpdates();
  } else {
    document.getElementById('authMsg').style.display='block';
  }
}

function togglePassword(){
  const pass = document.getElementById('ownerCode');
  pass.type = pass.type === 'password' ? 'text' : 'password';
}

function saveSalaryRate(){
  const val = parseFloat(document.getElementById('salaryRate').value);
  if(!isNaN(val) && val>0){
    salaryRate = val;
    localStorage.setItem('salaryRate', String(val));
    alert('Salary Rate Saved');
  }
}

async function deleteMonthHistory(){
  if(!confirm('Delete ALL records of this month for ALL workers?')) return;
  const now = new Date();
  const mKey = monthKeyFromDate(now);
  try{
    await db.collection('workData').doc(mKey).set({});
    alert('Month history deleted');
  }catch(e){
    console.error(e);
    alert('Delete failed. Check rules/network.');
  }
}

function listenRealtimeUpdates(){
  const now = new Date();
  const mKey = monthKeyFromDate(now);
  const container = document.getElementById('workerHistory');

  db.collection('workData').doc(mKey).onSnapshot(docSnap => {
    container.innerHTML = '';
    if(!docSnap.exists){
      container.innerHTML = '<div class="card">No data yet for this month.</div>';
      return;
    }
    const data = docSnap.data() || {};
    const names = Object.keys(data).sort((a,b)=>a.localeCompare(b));

    names.forEach(name => {
      const sessions = (data[name] || []).slice().sort((a,b)=> (a.start||'').localeCompare(b.start||''));
      let totalH = 0, totalP = 0;
      let rows = sessions.map(s => {
        const start = s.start ? new Date(s.start).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'medium' }) : '';
        const end   = s.end   ? new Date(s.end).toLocaleString('en-IN', { dateStyle: 'short', timeStyle: 'medium' })   : '';
        totalH += Number(s.hours||0);
        totalP += Number(s.pay||0);
        return `<tr>
                  <td>${start}</td>
                  <td>${end}</td>
                  <td>${(s.hours||0).toFixed(2)}</td>
                  <td>${(s.pay||0).toFixed(2)}</td>
                </tr>`;
      }).join('');

      const card = document.createElement('div');
      card.className = 'worker-card';
      card.innerHTML = `
        <h3>${name}</h3>
        <table class="table">
          <tr><th>Start</th><th>End</th><th>Hours</th><th>Pay</th></tr>
          ${rows || ''}
        </table>
        <p><strong>Total Hours:</strong> ${totalH.toFixed(2)} &nbsp; | &nbsp; 
        <strong>Total Pay:</strong> ${totalP.toFixed(2)}</p>
        ${sessions.length && !sessions[sessions.length-1].end ? '<p class="small">⏳ Active session running...</p>' : ''}
      `;
      container.appendChild(card);
    });
  }, err => {
    console.error(err);
    container.innerHTML = `<div class="card" style="color:red;">Listener error: ${err.message}</div>`;
  });
}
</script>
</body>
</html>
